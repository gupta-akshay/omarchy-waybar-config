name: Generate Release Notes

on:
  release:
    types: [created]

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Release Notes
        id: generate_notes
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = context.payload.release.tag_name;
            
            let releaseNotes = '';
            
            // Try to use GitHub's built-in release notes generation
            try {
              const response = await github.rest.repos.generateReleaseNotes({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
              });
              
              releaseNotes = response.data.body;
            } catch (error) {
              // Fallback to git-based generation if API fails
              console.log('GitHub API failed, using git-based generation');
              
              // Get previous tag
              const { execSync } = require('child_process');
              let prevTag = '';
              try {
                prevTag = execSync('git describe --tags --abbrev=0 HEAD^', { encoding: 'utf-8' }).trim();
              } catch (e) {
                // No previous tag
              }
              
              // Get commits
              let commits;
              if (prevTag) {
                commits = execSync(`git log --pretty=format:"- %s (%h)" ${prevTag}..HEAD`, { encoding: 'utf-8' });
              } else {
                commits = execSync('git log --pretty=format:"- %s (%h)" HEAD', { encoding: 'utf-8' });
              }
              
              const changelogLink = prevTag ? `**Full Changelog**: ${prevTag}..${tagName}` : '';
              
              releaseNotes = `## What's Changed\n\n${commits}\n\n${changelogLink}`;
            }
            
            core.setOutput('notes', releaseNotes);

      - name: Update Release Notes
        uses: actions/github-script@v7
        with:
          script: |
            const releaseId = context.payload.release.id;
            const releaseNotes = `${{ steps.generate_notes.outputs.notes }}`;
            
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              body: releaseNotes
            });

